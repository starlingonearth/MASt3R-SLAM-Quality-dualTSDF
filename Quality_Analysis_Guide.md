# MASt3R-SLAM Qualityè´¨é‡åˆ†ææ¨¡å—å®Œå…¨æŒ‡å—

## ğŸ“š ç›®å½•

1. [æ¨¡å—æ¦‚è¿°](#1-æ¨¡å—æ¦‚è¿°)
2. [æ ¸å¿ƒæ¦‚å¿µ](#2-æ ¸å¿ƒæ¦‚å¿µ)
3. [ç®—æ³•æ¡†æ¶](#3-ç®—æ³•æ¡†æ¶)
4. [è¯¦ç»†æŠ€æœ¯æµç¨‹](#4-è¯¦ç»†æŠ€æœ¯æµç¨‹)
5. [ä»£ç å®ç°è¯¦è§£](#5-ä»£ç å®ç°è¯¦è§£)
6. [å‚æ•°é…ç½®](#6-å‚æ•°é…ç½®)
7. [ä½¿ç”¨ç¤ºä¾‹](#7-ä½¿ç”¨ç¤ºä¾‹)
8. [å¸¸è§é—®é¢˜](#8-å¸¸è§é—®é¢˜)

---

## 1. æ¨¡å—æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯Qualityè´¨é‡åˆ†æï¼Ÿ

**Qualityè´¨é‡åˆ†ææ¨¡å—**æ˜¯MASt3R-SLAMä¸­çš„ä¸€ä¸ª**å…³é”®å¸§è´¨é‡è¯„ä¼°ç³»ç»Ÿ**ï¼Œç”¨äºï¼š

- âœ… **è¯„ä¼°å…³é”®å¸§çš„å¯é æ€§**ï¼šåˆ¤æ–­å“ªäº›å…³é”®å¸§çš„3Dé‡å»ºè´¨é‡é«˜
- âœ… **è¯†åˆ«éœ€è¦ä¼˜åŒ–çš„åŒºåŸŸ**ï¼šæ‰¾å‡ºé‡å»ºè´¨é‡å·®çš„å›¾åƒåŒºåŸŸ
- âœ… **æŒ‡å¯¼TSDFç»†åŒ–**ï¼šä¸ºTSDFç»†åŒ–æ¨¡å—æä¾›ä¼˜å…ˆçº§ä¿¡æ¯
- âœ… **ç›‘æ§ç³»ç»ŸçŠ¶æ€**ï¼šå®æ—¶è·Ÿè¸ªSLAMç³»ç»Ÿçš„æ•´ä½“è´¨é‡

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦Qualityåˆ†æï¼Ÿ

åœ¨è§†è§‰SLAMä¸­ï¼Œä¸æ˜¯æ‰€æœ‰å…³é”®å¸§çš„è´¨é‡éƒ½ä¸€æ ·å¥½ï¼š

| æƒ…å†µ | åŸå›  | åæœ |
|------|------|------|
| ğŸŸ¢ é«˜è´¨é‡ | çº¹ç†ä¸°å¯Œã€å…‰ç…§è‰¯å¥½ã€è§†è§’åˆé€‚ | é‡å»ºå‡†ç¡® |
| ğŸŸ¡ ä¸­è´¨é‡ | éƒ¨åˆ†æ¨¡ç³Šã€çº¹ç†ä¸€èˆ¬ | é‡å»ºå¯ç”¨ä½†ä¸å®Œç¾ |
| ğŸ”´ ä½è´¨é‡ | è¿åŠ¨æ¨¡ç³Šã€å¼±çº¹ç†ã€é®æŒ¡ | é‡å»ºä¸å¯é  |

**Qualityæ¨¡å—çš„ä½œç”¨**ï¼š
1. è‡ªåŠ¨è¯†åˆ«è´¨é‡é—®é¢˜
2. é‡åŒ–è¯„ä¼°æ¯ä¸ªåŒºåŸŸçš„å¯é æ€§
3. æŒ‡å¯¼åç»­ä¼˜åŒ–å’Œç»†åŒ–

### 1.3 æ¨¡å—æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         MASt3R-SLAM Main Thread         â”‚
â”‚  (Tracking + Backend Optimization)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ submit job
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   AsynchronousQualityService (å¼‚æ­¥æœåŠ¡)  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Job Queue (ä»»åŠ¡é˜Ÿåˆ—)              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                  â”‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Worker Thread (è®¡ç®—çº¿ç¨‹)         â”‚  â”‚
â”‚  â”‚  - æ‰¹é‡å¤„ç†                        â”‚  â”‚
â”‚  â”‚  - GPUåŠ é€Ÿ                         â”‚  â”‚
â”‚  â”‚  - quality_core.compute_batch()   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                  â”‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Result Queue (ç»“æœé˜Ÿåˆ—)          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ poll results
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         TSDF Refiner (TSDFç»†åŒ–æ¨¡å—)      â”‚
â”‚  - è·å–qualityç»“æœ                       â”‚
â”‚  - æ ¹æ®priorityä¼˜å…ˆçº§é€‰æ‹©ç»†åŒ–åŒºåŸŸ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æ ¸å¿ƒæ¦‚å¿µ

### 2.1 å…³é”®æŒ‡æ ‡

Qualityæ¨¡å—è®¡ç®—**ä¸‰ä¸ªæ ¸å¿ƒæŒ‡æ ‡**ï¼š

#### ğŸ“Š æŒ‡æ ‡1: Coverage Delta (Î”cov) - è¦†ç›–å˜åŒ–ç‡

**å®šä¹‰**ï¼šå…³é”®å¸§è¢«å…¶ä»–è§†è§’è§‚æµ‹åˆ°çš„ç¨‹åº¦å˜åŒ–

```python
è¦†ç›–åº¦ = æœ‰æ•ˆåƒç´ æ¯”ä¾‹ Ã— è§†è§’æƒé‡
Î”cov = EWMA(å½“å‰è¦†ç›–) - EWMA(å†å²è¦†ç›–)
```

**ç‰©ç†æ„ä¹‰**ï¼š
- `Î”cov > 0`ï¼šè¯¥å…³é”®å¸§æŒç»­è¢«æ–°è§†è§’è§‚æµ‹åˆ°ï¼ˆå¥½ï¼‰
- `Î”cov â‰ˆ 0`ï¼šè§‚æµ‹åœæ»ï¼ˆå¯èƒ½éœ€è¦å…³æ³¨ï¼‰
- `Î”cov < 0`ï¼šè§‚æµ‹å‡å°‘ï¼ˆå¼‚å¸¸ï¼‰

**ä¸ºä»€ä¹ˆé‡è¦**ï¼š
- é«˜è¦†ç›– = å¤šè§†è§’çº¦æŸ = å¯é é‡å»º
- ä½è¦†ç›– = ç¼ºä¹çº¦æŸ = ä¸ç¡®å®šæ€§é«˜

#### ğŸ“ æŒ‡æ ‡2: Residual (r) - é‡æŠ•å½±æ®‹å·®

**å®šä¹‰**ï¼š3Dç‚¹é‡æŠ•å½±å›å›¾åƒçš„åƒç´ è¯¯å·®

```python
å¯¹äºæ¯ä¸ª3Dç‚¹:
  p_reproj = Project(X_3D, T_camera)  # é‡æŠ•å½±
  r_pixel = ||p_reproj - p_observed||  # åƒç´ è¯¯å·®
  
å¯¹æ•´ä¸ªpatch:
  r = median(r_pixel)  # ä¸­ä½æ•°æ®‹å·®
```

**ç‰©ç†æ„ä¹‰**ï¼š
- `r` å°ï¼šé‡å»ºä¸è§‚æµ‹ä¸€è‡´ï¼ˆå¥½ï¼‰
- `r` å¤§ï¼šå­˜åœ¨å‡ ä½•è¯¯å·®ï¼ˆå·®ï¼‰

**å…¸å‹å€¼**ï¼š
- r < 1 pixelï¼šä¼˜ç§€
- 1-3 pixelsï¼šè‰¯å¥½
- > 5 pixelsï¼šéœ€è¦ä¼˜åŒ–

#### ğŸ¯ æŒ‡æ ‡3: Uncertainty (u) - ä¸ç¡®å®šåº¦

**å®šä¹‰**ï¼šåŸºäºMASt3Rç½®ä¿¡åº¦å’ŒåŒ¹é…è´¨é‡çš„ç»¼åˆä¸ç¡®å®šæ€§

```python
u = 1 - sqrt(C_normalized Ã— Q_normalized)

å…¶ä¸­:
  C = MASt3Rç½®ä¿¡åº¦ (0-1)
  Q = åŒ¹é…è´¨é‡ (0-1)
```

**ç‰©ç†æ„ä¹‰**ï¼š
- `u` å°ï¼šé¢„æµ‹å¯é ï¼ˆå¥½ï¼‰
- `u` å¤§ï¼šé¢„æµ‹ä¸ç¡®å®šï¼ˆå·®ï¼‰

**å½±å“å› ç´ **ï¼š
- çº¹ç†è´¨é‡ï¼ˆçº¹ç†è¶Šä¸°å¯Œï¼ŒCè¶Šé«˜ï¼‰
- å…‰ç…§æ¡ä»¶
- è¿åŠ¨æ¨¡ç³Š
- é®æŒ¡

### 2.2 è´¨é‡åˆ†ç±»

åŸºäºä¸‰ä¸ªæŒ‡æ ‡ï¼Œæ¯ä¸ªpatchè¢«åˆ†ä¸º**4ä¸ªè´¨é‡ç±»åˆ«**ï¼š

```python
Class 0: æœªåˆ†ç±»/é»˜è®¤
Class 1: åœæ»ä½ç½®ä¿¡ (Î”cov < 0.02 ä¸” ué«˜)
Class 2: æ´»è·ƒé«˜æ®‹å·® (Î”cov â‰¥ 0.02 ä¸” ré«˜ ä¸” ué«˜)  
Class 3: é«˜æ®‹å·®ä½ä¸ç¡®å®š (ré«˜ ä¸” uä½)
```

| ç±»åˆ« | Î”cov | r | u | å«ä¹‰ | ä¼˜å…ˆçº§ |
|------|------|---|---|------|--------|
| **Class 1** | ä½ | - | é«˜ | è§‚æµ‹åœæ»ä¸”ä¸ç¡®å®š | ä¸­ |
| **Class 2** | é«˜ | é«˜ | é«˜ | æ´»è·ƒä½†æœ‰å‡ ä½•è¯¯å·® | é«˜ |
| **Class 3** | - | é«˜ | ä½ | å‡ ä½•è¯¯å·®ä½†ç½®ä¿¡åº¦é«˜ | ä¸­é«˜ |

### 2.3 ä¼˜å…ˆçº§è¯„åˆ†

æ¯ä¸ªpatchå¾—åˆ°ä¸€ä¸ª**priority score (0-1)**ï¼š

```python
if cls == 1:  # åœæ»ä½ç½®ä¿¡
    priority = (1 - Î”cov) + z_u
    
elif cls == 2:  # æ´»è·ƒé«˜æ®‹å·®
    priority = z_r + z_u
    
elif cls == 3:  # é«˜æ®‹å·®ä½ä¸ç¡®å®š
    priority = z_r + (1 - u)

# å½’ä¸€åŒ–åˆ° [0, 1]
priority = priority / max(priority)
```

**priorityè¶Šé«˜ = è¶Šéœ€è¦TSDFç»†åŒ–**

---

## 3. ç®—æ³•æ¡†æ¶

### 3.1 æ€»ä½“æµç¨‹

```
è¾“å…¥: å…³é”®å¸§æ•°æ® (å›¾åƒã€3Dç‚¹ã€ç½®ä¿¡åº¦ç­‰)
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: æ•°æ®å‡†å¤‡                    â”‚
â”‚ - æå–å…³é”®å¸§ä¿¡æ¯                    â”‚
â”‚ - è®¡ç®—è§†è§’å‚æ•° (t_norm, theta)     â”‚
â”‚ - æ”¶é›†å†å²EWMAçŠ¶æ€                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: æäº¤ä»»åŠ¡                    â”‚
â”‚ - æ‰“åŒ…jobå­—å…¸                       â”‚
â”‚ - æäº¤åˆ°å¼‚æ­¥æœåŠ¡                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: å¼‚æ­¥è®¡ç®— (Worker Thread)    â”‚
â”‚ - æ‰¹é‡æ”¶é›†ä»»åŠ¡                      â”‚
â”‚ - å¹¶è¡Œè®¡ç®—qualityæŒ‡æ ‡               â”‚
â”‚ - GPUåŠ é€Ÿ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: ç»“æœå¤„ç†                    â”‚
â”‚ - å­˜å‚¨åˆ°cache                      â”‚
â”‚ - æ›´æ–°å…¨å±€ç»Ÿè®¡                      â”‚
â”‚ - è§¦å‘å›è°ƒé€šçŸ¥                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: ç»“æœä½¿ç”¨                    â”‚
â”‚ - TSDF RefineræŸ¥è¯¢ç»“æœ              â”‚
â”‚ - æ ¹æ®priorityè°ƒåº¦ç»†åŒ–              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ•°æ®æµ

```
Tracker               Quality Service           TSDF Refiner
  â”‚                         â”‚                        â”‚
  â”‚ â”€â”€submit(job)â”€â”€>        â”‚                        â”‚
  â”‚                         â”‚                        â”‚
  â”‚                    [Workerè®¡ç®—]                  â”‚
  â”‚                         â”‚                        â”‚
  â”‚                    [å­˜å‚¨ç»“æœ]                     â”‚
  â”‚                         â”‚                        â”‚
  â”‚                         â”‚  <â”€â”€poll()â”€â”€â”€         â”‚
  â”‚                         â”‚                        â”‚
  â”‚                         â”‚  â”€â”€resultâ”€â”€>          â”‚
  â”‚                         â”‚                        â”‚
  â”‚                         â”‚        [ä½¿ç”¨priorityè°ƒåº¦ç»†åŒ–]
  â”‚                         â”‚                        â”‚
```

---

## 4. è¯¦ç»†æŠ€æœ¯æµç¨‹

### 4.1 Step 1: è¦†ç›–åº¦è®¡ç®—

#### 4.1.1 æœ‰æ•ˆåƒç´ ç½‘æ ¼

å°†å›¾åƒåˆ’åˆ†ä¸º`patch_size Ã— patch_size`çš„ç½‘æ ¼ï¼ˆé»˜è®¤16Ã—16ï¼‰ï¼š

```python
# ç¤ºä¾‹ï¼š512Ã—512å›¾åƒï¼Œpatch_size=16
# å¾—åˆ°ï¼š32Ã—32çš„ç½‘æ ¼

grid_h = H // patch_size  # 32
grid_w = W // patch_size  # 32
```

å¯¹æ¯ä¸ªpatchï¼Œè®¡ç®—**æœ‰æ•ˆåƒç´ æ¯”ä¾‹**ï¼š

```python
def valid_grid(valid_mask, H, W, patch_size):
    # valid_mask: HWçš„boolæ©ç ï¼ŒTrueè¡¨ç¤ºæœ‰æ•ˆç‚¹
    
    # åˆ’åˆ†ç½‘æ ¼
    grid = divide_into_patches(valid_mask, patch_size)
    
    # æ¯ä¸ªpatchçš„æœ‰æ•ˆæ¯”ä¾‹
    coverage = mean(grid, dim=-1)  # [grid_h, grid_w]
    
    return coverage
```

#### 4.1.2 è§†è§’æƒé‡

è€ƒè™‘**æ—¶é—´é—´éš”**å’Œ**è§’åº¦å˜åŒ–**ï¼š

```python
def view_weight(t_norm, theta, b0=0.15, theta0=10Â°):
    # t_norm: å½’ä¸€åŒ–æ—¶é—´é—´éš” (0-1)
    # theta: è§†è§’è§’åº¦å˜åŒ– (å¼§åº¦)
    
    t_weight = clamp(t_norm / b0, 0, 1)
    r_weight = clamp(theta / theta0, 0, 1)
    
    weight = 0.5 * (t_weight + r_weight)
    return weight
```

**ç‰©ç†æ„ä¹‰**ï¼š
- æ—¶é—´é—´éš”å¤§ â†’ t_weighté«˜ â†’ æ›´æœ‰ä»·å€¼çš„æ–°è§‚æµ‹
- è§’åº¦å˜åŒ–å¤§ â†’ r_weighté«˜ â†’ æ›´å¤šæ–°ä¿¡æ¯

#### 4.1.3 EWMAæ›´æ–°

ä½¿ç”¨**æŒ‡æ•°åŠ æƒç§»åŠ¨å¹³å‡**å¹³æ»‘è¦†ç›–åº¦ï¼š

```python
def ema_delta(prev_ewma, increment, alpha=0.8):
    # prev_ewma: å†å²EWMAå€¼
    # increment: å½“å‰è§‚æµ‹å€¼
    # alpha: å¹³æ»‘ç³»æ•° (0.8è¡¨ç¤ºå†å²æƒé‡80%)
    
    new_ewma = alpha * prev_ewma + (1-alpha) * increment
    delta = new_ewma - prev_ewma
    
    return new_ewma, delta
```

**ç¤ºä¾‹**ï¼š
```
Frame 1: coverage = 0.5
  â†’ EWMA = 0.5, Î” = 0.5

Frame 2: coverage = 0.7
  â†’ EWMA = 0.8Ã—0.5 + 0.2Ã—0.7 = 0.54
  â†’ Î” = 0.04

Frame 3: coverage = 0.9
  â†’ EWMA = 0.8Ã—0.54 + 0.2Ã—0.9 = 0.612
  â†’ Î” = 0.072
```

### 4.2 Step 2: æ®‹å·®è®¡ç®—

#### 4.2.1 åƒç´ æ®‹å·®ç½‘æ ¼åŒ–

```python
def r_from_scalar(r_pixel, H, W, patch_size, valid_mask):
    # r_pixel: HWçš„åƒç´ æ®‹å·® (æ¯ä¸ªåƒç´ ä¸€ä¸ªå€¼)
    
    # åˆ’åˆ†ç½‘æ ¼
    grid = divide_into_patches(r_pixel, patch_size)
    
    # åªè€ƒè™‘æœ‰æ•ˆåƒç´ 
    grid_masked = mask(grid, valid_mask)
    
    # æ¯ä¸ªpatchå–ä¸­ä½æ•°ï¼ˆé²æ£’ï¼‰
    r_patch = median(grid_masked, dim=-1)
    
    return r_patch  # [grid_h, grid_w]
```

**ä¸ºä»€ä¹ˆç”¨ä¸­ä½æ•°**ï¼š
- å‡å€¼å¯¹å¼‚å¸¸å€¼æ•æ„Ÿ
- ä¸­ä½æ•°æ›´é²æ£’ï¼Œèƒ½æŠµæŠ—outliers

### 4.3 Step 3: ä¸ç¡®å®šåº¦è®¡ç®—

#### 4.3.1 ç½®ä¿¡åº¦å½’ä¸€åŒ–

```python
def u_from_CQ(C, Q, C_thr, Q_thr, H, W, patch_size):
    # C: MASt3Rç½®ä¿¡åº¦ [HW]
    # Q: åŒ¹é…è´¨é‡ [HW]
    
    # å½’ä¸€åŒ–
    C_norm = clamp(C / (C_thr + eps), 0, 1)
    Q_norm = clamp(Q / (Q_thr + eps), 0, 1)
    
    # ç»¼åˆä¸ç¡®å®šåº¦
    U = 1 - sqrt(C_norm * Q_norm)
    
    # ç½‘æ ¼åŒ–ï¼ˆå–ä¸­ä½æ•°ï¼‰
    u_patch = reduce_grid(U, H, W, patch_size, method="median")
    
    return u_patch
```

**ä¸ºä»€ä¹ˆç”¨å‡ ä½•å¹³å‡**ï¼ˆsqrt(CÃ—Q)ï¼‰ï¼š
- ä¸¤ä¸ªéƒ½é«˜æ‰ç®—å¯é 
- ä»»ä¸€ä¸ªä½éƒ½ä¼šå¯¼è‡´é«˜ä¸ç¡®å®šåº¦

### 4.4 Step 4: é²æ£’åˆ†ç±»

#### 4.4.1 Robust Z-score

ä½¿ç”¨**MAD (Median Absolute Deviation)**è®¡ç®—z-scoreï¼š

```python
def robust_z(x):
    median = torch.median(x)
    mad = torch.median(torch.abs(x - median)) + 1e-6
    
    z = (x - median) / mad
    return z
```

**ä¸ºä»€ä¹ˆä¸ç”¨æ ‡å‡†å·®**ï¼š
- æ ‡å‡†å·®å—å¼‚å¸¸å€¼å½±å“å¤§
- MADæ›´é²æ£’

#### 4.4.2 åˆ†ç±»è§„åˆ™

```python
def classify(delta_cov, r, u):
    # è®¡ç®—robust z-score
    z_r = robust_z(r)
    z_u = robust_z(u)
    
    # åˆ†ç±»æ¡ä»¶
    c1 = (delta_cov < 0.02) & (z_u > 1.0)      # åœæ»ä½ç½®ä¿¡
    c2 = (delta_cov >= 0.02) & (z_r > 1.0) & (z_u > 1.0)  # æ´»è·ƒé«˜æ®‹å·®
    c3 = (z_r > 1.0) & (z_u <= 1.0)            # é«˜æ®‹å·®ä½ä¸ç¡®å®š
    
    cls = torch.zeros_like(r, dtype=torch.long)
    cls[c1] = 1
    cls[c2] = 2
    cls[c3] = 3
    
    return cls
```

### 4.5 Step 5: ä¼˜å…ˆçº§è¯„åˆ†

```python
def compute_priority(cls, delta_cov, z_r, z_u, u):
    p = torch.zeros_like(r)
    
    # Class 1: åœæ»åŒºåŸŸä¼˜å…ˆçº§
    mask1 = (cls == 1)
    if mask1.any():
        p[mask1] = (1 - clamp(delta_cov, 0, 1)) + clamp(z_u, 0)
    
    # Class 2: æ´»è·ƒä½†æœ‰è¯¯å·®åŒºåŸŸ
    mask2 = (cls == 2)
    if mask2.any():
        p[mask2] = clamp(z_r, 0) + clamp(z_u, 0)
    
    # Class 3: å‡ ä½•è¯¯å·®åŒºåŸŸ
    mask3 = (cls == 3)
    if mask3.any():
        p[mask3] = clamp(z_r, 0) + clamp(1 - u, 0)
    
    # å½’ä¸€åŒ–
    p = p / (p.max() + 1e-6)
    
    return p
```

---

## 5. ä»£ç å®ç°è¯¦è§£

### 5.1 æ ¸å¿ƒå‡½æ•°ï¼šcompute_batch

```python
# æ–‡ä»¶: quality_core.py
def compute_batch(batch, ps, alpha, b0, theta0, 
                  C_thr, Q_thr, thr_zr, thr_zu, thr_dc, device):
    """
    æ‰¹é‡è®¡ç®—qualityæŒ‡æ ‡
    
    å‚æ•°:
        batch: ä»»åŠ¡åˆ—è¡¨ï¼Œæ¯ä¸ªåŒ…å«å…³é”®å¸§æ•°æ®
        ps: patch_size (é»˜è®¤16)
        alpha: EWMAå¹³æ»‘ç³»æ•° (é»˜è®¤0.8)
        b0: æ—¶é—´é—´éš”é˜ˆå€¼ (é»˜è®¤0.15)
        theta0: è§’åº¦é˜ˆå€¼ (é»˜è®¤10åº¦)
        C_thr: ç½®ä¿¡åº¦é˜ˆå€¼
        Q_thr: è´¨é‡é˜ˆå€¼
        thr_zr: æ®‹å·®z-scoreé˜ˆå€¼ (é»˜è®¤1.0)
        thr_zu: ä¸ç¡®å®šåº¦z-scoreé˜ˆå€¼ (é»˜è®¤1.0)
        thr_dc: è¦†ç›–å˜åŒ–é˜ˆå€¼ (é»˜è®¤0.02)
        device: è®¡ç®—è®¾å¤‡ (cuda/cpu)
    
    è¿”å›:
        results: ç»“æœåˆ—è¡¨ï¼Œæ¯ä¸ªåŒ…å«qualityæŒ‡æ ‡
    """
    results = []
    
    for job in batch:
        H, W = job["H"], job["W"]
        
        # 1. è®¡ç®—è¦†ç›–åº¦å¢é‡
        valid = job["valid_kf"].to(device)
        inc = valid_grid(valid, H, W, ps) * \
              view_weight(job["t_norm"], job["theta"], b0, theta0, device)
        
        # 2. EWMAæ›´æ–°
        prev = job.get("cov_ewma", None)
        if prev is None:
            prev = torch.zeros_like(inc, device=device)
        ewma, delta_cov = ema_delta(prev, inc, alpha)
        
        # 3. è®¡ç®—æ®‹å·®
        r = r_from_scalar(job["r_pix"], H, W, ps, valid=valid)
        
        # 4. è®¡ç®—ä¸ç¡®å®šåº¦
        u = u_from_CQ(job["Ck"], job["Qk"], C_thr, Q_thr, H, W, ps)
        
        # 5. åˆ†ç±»å’Œä¼˜å…ˆçº§
        cls, priority = classify(delta_cov, r, u, thr_zr, thr_zu, thr_dc)
        
        # 6. æ‰“åŒ…ç»“æœ
        result = pack_result(job["kf_id"], delta_cov, r, u, cls, priority, ewma)
        results.append(result)
    
    return results
```

### 5.2 å¼‚æ­¥æœåŠ¡ï¼šAsynchronousQualityService

#### 5.2.1 åˆå§‹åŒ–

```python
# æ–‡ä»¶: quality_async.py
class AsynchronousQualityService:
    def __init__(self, manager=None, device=None):
        # é˜Ÿåˆ—
        self.job_q = queue.Queue(maxsize=100)
        self.res_q = queue.Queue(maxsize=100)
        
        # åŒç´¢å¼•cache
        self.cache_by_kf_id = {}
        self.cache_by_frame_id = {}
        
        # EWMAçŠ¶æ€æŒä¹…åŒ–
        self.ewma_state = {}
        
        # å…¨å±€ç»Ÿè®¡
        self.global_stats = {
            "r_median": 1.0, "r_mad": 0.5,
            "u_median": 0.5, "u_mad": 0.2
        }
        self.stats_window = deque(maxlen=50)
        
        # GPUè®¾å¤‡
        self.device = device or ("cuda" if torch.cuda.is_available() else "cpu")
        
        # å¯åŠ¨workerçº¿ç¨‹
        self.worker = threading.Thread(target=self._worker_loop, daemon=True)
        self.worker.start()
```

#### 5.2.2 ä»»åŠ¡æäº¤

```python
def submit(self, job):
    """æäº¤è´¨é‡è®¡ç®—ä»»åŠ¡"""
    # è‡ªåŠ¨æ³¨å…¥å†å²EWMA
    kf_id = job.get("kf_id")
    if kf_id in self.ewma_state:
        job["cov_ewma"] = self.ewma_state[kf_id]
    
    self.job_q.put_nowait(job)
```

#### 5.2.3 Workerå¾ªç¯

```python
def _worker_loop(self):
    """åå°è®¡ç®—çº¿ç¨‹"""
    while not self.stop_event.is_set():
        # æ”¶é›†æ‰¹æ¬¡
        jobs = self._collect_batch()
        if not jobs:
            continue
        
        # æ‰¹é‡è®¡ç®—
        results = compute_batch(jobs, ...)
        
        # è¿”å›ç»“æœ
        for r in results:
            self.res_q.put_nowait(r)
```

#### 5.2.4 ç»“æœæŸ¥è¯¢

```python
def poll(self):
    """è½®è¯¢ç»“æœé˜Ÿåˆ—"""
    while True:
        try:
            msg = self.res_q.get_nowait()
            self._process_result(msg)
        except queue.Empty:
            break

def get(self, kf_id):
    """æŸ¥è¯¢ç»“æœ"""
    self.poll()
    return self.cache_by_kf_id.get(int(kf_id), None)
```

---

## 6. å‚æ•°é…ç½®

### 6.1 é…ç½®æ–‡ä»¶ç¤ºä¾‹

```yaml
quality:
  patch_size: 16                # patchç½‘æ ¼å¤§å°
  batch_size: 4                 # æ‰¹å¤„ç†å¤§å°
  max_wait_ms: 20              # æ‰¹æ¬¡æ”¶é›†æœ€å¤§ç­‰å¾…æ—¶é—´(ms)
  
  metrics:
    coverage:
      alpha_ema: 0.8           # EWMAå¹³æ»‘ç³»æ•°
      b0: 0.15                  # æ—¶é—´é—´éš”é˜ˆå€¼
      theta0_deg: 10.0         # è§’åº¦é˜ˆå€¼(åº¦)
  
  thresholds:
    z_r: 1.0                    # æ®‹å·®z-scoreé˜ˆå€¼
    z_u: 1.0                    # ä¸ç¡®å®šåº¦z-scoreé˜ˆå€¼
    d_cov: 0.02                 # è¦†ç›–å˜åŒ–é˜ˆå€¼
```

### 6.2 å‚æ•°è¯´æ˜

| å‚æ•° | é»˜è®¤å€¼ | ä½œç”¨ | è°ƒä¼˜å»ºè®® |
|------|--------|------|----------|
| `patch_size` | 16 | patchå¤§å° | å¤ªå°=è®¡ç®—é‡å¤§ï¼Œå¤ªå¤§=ç²¾åº¦ä½ |
| `batch_size` | 4 | æ‰¹å¤„ç†æ•°é‡ | GPUæ˜¾å­˜å……è¶³å¯å¢å¤§ |
| `alpha_ema` | 0.8 | EWMAå†å²æƒé‡ | è¶Šå¤§=è¶Šå¹³æ»‘ï¼Œååº”è¶Šæ…¢ |
| `b0` | 0.15 | æ—¶é—´é—´éš”é˜ˆå€¼ | è°ƒæ•´è§†è§’æƒé‡æ•æ„Ÿåº¦ |
| `theta0_deg` | 10Â° | è§’åº¦é˜ˆå€¼ | è°ƒæ•´è§’åº¦æƒé‡æ•æ„Ÿåº¦ |
| `z_r` | 1.0 | æ®‹å·®æ•æ„Ÿåº¦ | è¶Šå°=è¶Šä¸¥æ ¼ |
| `z_u` | 1.0 | ä¸ç¡®å®šåº¦æ•æ„Ÿåº¦ | è¶Šå°=è¶Šä¸¥æ ¼ |
| `d_cov` | 0.02 | è¦†ç›–å˜åŒ–é˜ˆå€¼ | åˆ¤æ–­æ˜¯å¦"åœæ»" |

---

## 7. ä½¿ç”¨ç¤ºä¾‹

### 7.1 åœ¨Trackerä¸­æäº¤ä»»åŠ¡

```python
# æ–‡ä»¶: tracker.py
# åœ¨å…³é”®å¸§ä¼˜åŒ–åæäº¤qualityä»»åŠ¡

job = {
    "kf_id": current_kf_id,
    "frame_id": keyframe.frame_id,
    "H": img_height,
    "W": img_width,
    "t_norm": time_normalized,
    "theta": angle_change,
    "valid_kf": valid_mask,
    "r_pix": residual_pixels,
    "Ck": confidence,
    "Qk": quality
}

quality_service.submit(job)
```

### 7.2 åœ¨TSDF Refinerä¸­ä½¿ç”¨ç»“æœ

```python
# æ–‡ä»¶: tsdf_refine.py
# æŸ¥è¯¢qualityç»“æœå¹¶è°ƒåº¦ç»†åŒ–

quality_result = quality_service.get(kf_id)

if quality_result is not None:
    priority = quality_result["priority"]  # [grid_h, grid_w]
    
    # é€‰æ‹©top-Ké«˜ä¼˜å…ˆçº§patches
    top_patches = select_top_k(priority, k=10)
    
    # è°ƒåº¦ç»†åŒ–
    for patch in top_patches:
        schedule_tsdf_refinement(patch)
```

---

## 8. å¸¸è§é—®é¢˜

### Q1: Qualityè®¡ç®—å¾ˆæ…¢ï¼Ÿ

**åŸå› **ï¼šCPUè®¡ç®—æˆ–æ‰¹æ¬¡å¤ªå°

**è§£å†³**ï¼š
```python
# ç¡®ä¿ä½¿ç”¨GPU
quality_service = AsynchronousQualityService(device="cuda")

# å¢å¤§æ‰¹æ¬¡
quality:
  batch_size: 8  # æ”¹ä¸º8
```

### Q2: Priorityå…¨æ˜¯0ï¼Ÿ

**åŸå› **ï¼šé˜ˆå€¼è®¾ç½®ä¸åˆç†

**è°ƒè¯•**ï¼š
```python
result = quality_service.get(kf_id)
print(f"delta_cov range: {result['delta_cov'].min()}-{result['delta_cov'].max()}")
print(f"r range: {result['r'].min()}-{result['r'].max()}")
print(f"u range: {result['u'].min()}-{result['u'].max()}")
```

### Q3: EWMAçŠ¶æ€ä¸¢å¤±ï¼Ÿ

**åŸå› **ï¼šæœªæŒä¹…åŒ–

**è§£å†³**ï¼šå·²åœ¨`AsynchronousQualityService`ä¸­è‡ªåŠ¨å¤„ç†

---

## ğŸ“ æ€»ç»“

Qualityè´¨é‡åˆ†ææ¨¡å—é€šè¿‡**è¦†ç›–åº¦ã€æ®‹å·®ã€ä¸ç¡®å®šåº¦**ä¸‰ä¸ªæŒ‡æ ‡ï¼Œå…¨é¢è¯„ä¼°å…³é”®å¸§è´¨é‡ï¼Œä¸ºTSDFç»†åŒ–æä¾›æ™ºèƒ½è°ƒåº¦ä¾æ®ã€‚

**å…³é”®è¦ç‚¹**ï¼š
1. âœ… å¼‚æ­¥è®¡ç®—ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹
2. âœ… GPUåŠ é€Ÿï¼Œæ”¯æŒå®æ—¶å¤„ç†
3. âœ… EWMAå¹³æ»‘ï¼Œç¨³å®šå¯é 
4. âœ… é²æ£’åˆ†ç±»ï¼ŒæŠµæŠ—å¼‚å¸¸å€¼
5. âœ… ä¼˜å…ˆçº§è¯„åˆ†ï¼Œæ™ºèƒ½è°ƒåº¦

**åº”ç”¨åœºæ™¯**ï¼š
- TSDFç»†åŒ–è°ƒåº¦
- å…³é”®å¸§ç­›é€‰
- ç³»ç»Ÿè´¨é‡ç›‘æ§
- å›ç¯æ£€æµ‹è¾…åŠ©
